# Copyright (C) 2022 Intel Corporation
# SPDX-License-Identifier: GPL-3.0-or-later

import json
import subprocess

from cve_bin_tool.parsers import Parser


class PythonParser(Parser):
    def __init__(self, cve_db, logger):
        super().__init__(cve_db, logger)

    def run_checker(self, filename):
        self.filename = filename
        lines = json.loads(
            subprocess.check_output(
                [
                    "pip3",
                    "install",
                    "-r",
                    self.filename,
                    "--dry-run",
                    "--ignore-installed",
                    "--report",
                    "-",
                    "--quiet",
                ]
            )
        )
        for line in lines["install"]:
            product = line["metadata"]["name"]
            version = line["metadata"]["version"]
            vendor = self.find_vendor(product, version)
            if vendor is not None:
                yield from vendor
        self.logger.debug(f"Done scanning file: {self.filename}")
